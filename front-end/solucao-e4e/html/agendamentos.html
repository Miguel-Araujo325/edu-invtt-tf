<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizar Agendamentos</title>

    <link rel="stylesheet" href="../../css/Aluno/visualizarAgendamentos.css">
    <link rel="stylesheet" href="../../css/Aluno/tabelaAgendamentos.css">
    <link rel="stylesheet" href="../css/menu.css">
    <link rel="stylesheet" href="../css/loading.css">

    <script defer src="../js/script.js"></script>
    <script defer src="../js/pilha.js"></script>
    <script src="../js/agendamentos/exibirAgendamentos.js"></script>
    <script src="../js/agendamentos/filter.js"></script>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
        integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
        integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
        integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
        crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="icon" type="image/png" href="../imgs/english4ever.png">
</head>
<style>
    .progress-bar {
        background-color: #072B59;
        height: 5px;
        transition: width 5s linear;
    }

    .progress {
        height: 5px;
        width: 97%;
    }
</style>

<body>
    <!-- <div id="loading" style="display:none;">
        <img src="../imgs/Spin@1x-1.0s-200px-200px.gif" alt="Loading">
    </div> -->
    <div class="loading-container">
        <div id="loading"></div>
    </div>
    <nav class="sidebar" id="sidebar">
        <div class="hamburger">
            <a class="main-nav-toggle" href="#main-nav" id="toggle-btn"><i>Menu</i></a>
        </div>
        <ul class="nav flex-column">
            <li class="nav-item">
                <a id="dashboard_href" href="#" class="nav-link">
                    <img src="../imgs/botao-home.png" alt=""> <span class="ms-2">Início</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="collapse" data-bs-target="#agendaDropdown"
                    aria-expanded="false">
                    <img src="../imgs/calendar-days.png" alt=""> <span class="ms-2">Agenda</span>
                </a>
                <div class="collapse" id="agendaDropdown">
                    <ul class="nav flex-column dropdown-container">
                        <li><a href="calendarioAluno.html" id="agenda_novo_agendamento_navbar" class="nav-link">Novo
                                Agendamento</a></li>
                        <li><a href="agendamentos.html?tipo=futuro" id="agenda_meus_agendamentos_navbar"
                                class="nav-link">Meus Agendamentos</a></li>
                        <li><a href="agendamentos.html?tipo=passado" id="agenda_historico_navbar"
                                class="nav-link">Histórico</a></li>
                    </ul>
                </div>
            </li>
            <li class="nav-item" id="alunos_navbar">
                <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="collapse" data-bs-target="#alunosDropdown"
                    aria-expanded="false">
                    <img src="../imgs/students.png" alt=""> <span class="ms-2">Alunos</span>
                </a>
                <div class="collapse" id="alunosDropdown">
                    <ul class="nav flex-column dropdown-container">
                        <li><a href="visualizar.html?tipo=aluno" class="nav-link">Visualizar</a></li>
                        <li><a href="cadastrar.html?tipo=aluno" class="nav-link">Cadastrar</a></li>
                    </ul>
                </div>
            </li>
            <li class="nav-item" id="professores_navbar">
                <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="collapse"
                    data-bs-target="#professoresDropdown" aria-expanded="false">
                    <img src="../imgs/professor.png" alt=""> <span class="ms-2">Professores</span>
                </a>
                <div class="collapse" id="professoresDropdown">
                    <ul class="nav flex-column dropdown-container">
                        <li><a href="visualizar.html?tipo=professor" class="nav-link">Visualizar</a></li>
                        <li><a href="cadastrar.html?tipo=professor" id="cadastro_professor"
                                class="nav-link">Cadastrar</a></li>
                    </ul>
                </div>
            </li>
            <li class="nav-item">
                <a href="perfil.html" id="perfil_navbar" class="nav-link">
                    <img src="../imgs/perfil.png" alt=""> <span class="ms-2">Perfil</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="http://20.161.82.110/" target="_blank" class="nav-link">
                    <img src="../imgs/moodle.png" alt=""> <span class="ms-2">Moodle</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="login2.html" class="nav-link">
                    <img src="../imgs/sair.png" alt=""> <span class="ms-2" style="color: white;">Sair</span>
                </a>
            </li>
        </ul>
    </nav>

    <div class="conteudo" id="listagem">
        <div class="breadcrumb-container" style="display: flex; align-items: center; justify-content: space-between;">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="#">Início</a></li>
                    <li class="breadcrumb-item"><a href="#">Calendário</a></li>
                    <li class="breadcrumb-item active" aria-current="page" id="titulo_breadcrumb">Agendamentos</li>
                </ol>
            </nav>

            <!-- <div class="button-container">
                <button type="button" class="custom-button">
                    <i class="fas fa-download" style="margin-right: 5px;"></i> Baixar Dados
                </button>
            </div> -->
        </div>
        <br>
        <div class="dados">
            <br>
            <div class="inputs">
                <div class="mb-3 d-flex justify-content-center align-items-center">
                    <label for="data_inicio" class="form-label me-3">Data de:</label>
                    <input type="date" class="form-control" id="data_inicio" required>
                </div>
                <div class="mb-3 d-flex justify-content-center align-items-center">
                    <label for="data_fim" class="form-label me-3">até:</label>
                    <input type="date" class="form-control" id="data_fim" required>
                </div>
                <div class="mb-3 d-flex justify-content-center align-items-center">
                    <label for="horario_inicio" class="form-label me-3" id="cpf">Horário de:</label>
                    <input type="time" class="form-control" id="horario_inicio" required>
                </div>
                <div class="mb-3 d-flex justify-content-center align-items-center">
                    <label for="horario_fim" class="form-label me-3" id="cpf">até:</label>
                    <input type="time" class="form-control" id="horario_fim" required>
                </div>
                <div class="mb-3 d-flex justify-content-center align-items-center">
                    <label for="input_cpf" class="form-label me-3" id="input_nome">Aluno:</label>
                    <input class="form-control" id="aluno" placeholder="João" required>
                </div>
                <!-- <div class="button-filter">
                    <button type="button" class="form-control" id="botaoFilter"
                        onclick="filtraAgendamentos()">Aplicar</button>
                </div> -->
            </div>
            <table class="tabela" id="tabela_agendamento">
                <table class="tabela" id="tabela_agendamento">
                </table>
                <ul class="pagination" id="paginacao_tabela">
                    <li class="page-item">
                        <a class="page-link" href="#" aria-label="Anterior">
                            <span aria-hidden="true">&laquo;</span>
                            <span class="sr-only">Anterior</span>
                        </a>
                    </li>
                </ul>
        </div>
</body>

</html>

<script>
    let autoDismissTimeout;

    const param = new URLSearchParams(window.location.search);

    if(Number(sessionStorage.getItem('nivel_acesso_cod')) == 1) {
        document.getElementById('input_nome').innerHTML = 'Professor:';
    } 
    
    document.addEventListener("DOMContentLoaded", () => {
        // Captura todos os inputs que têm IDs relacionados aos filtros
        const filterInputs = document.querySelectorAll("#data_inicio, #data_fim, #horario_inicio, #horario_fim, #aluno");

        // Adiciona o evento onchange para cada input
        filterInputs.forEach((input) => {
            input.addEventListener("change", () => {
                Filters.updateFromInputs(); // Atualiza o objeto Filters com os valores dos inputs
                carregarAgendamentos(0); // Chama a função para buscar agendamentos na página inicial
            });
        });
    });

    // if (param.get("tipo") === "passado") {
    //     document.querySelector(".button-container").style.display = "flex"; // Mostra a div
    // } else {
    //     document.querySelector(".button-container").style.display = "none"; // Oculta a div
    // }

    $(document).ready(function () {
        if (localStorage.getItem('exibirAlerta') === 'true') {
            var alertHtml = `
            <div class="alert alert-warning alert-dismissible fade show" role="alert"
                style="background-color: white; border-color: #072B59; color: #072B59; width: 20.6vw; position: fixed; top: 20px; right: 20px; z-index: 9999;"
                id="auto-dismiss-alert">
                Para desfazer o novo agendamento <strong style="cursor: pointer;" onclick="desfazerAgendamento()">clique aqui.</strong>
                <button type="button" class="close" data-dismiss="alert" aria-label="Close" style="color: #072B59;">
                    <span aria-hidden="true">&times;</span>
                </button>
                <div class="progress">
                    <div class="progress-bar" id="progress-bar"></div>
                </div>
            </div>
        `;

            $('body').append(alertHtml);

            var progressBar = $('#progress-bar');
            progressBar.css('width', '100%');

            autoDismissTimeout = setTimeout(function () {
                $('#auto-dismiss-alert').alert('close');
            }, 5000);

            setTimeout(function () {
                progressBar.css('width', '0%');
            }, 50);

            localStorage.removeItem('exibirAlerta');
        }
    });

    async function desfazerAgendamento() {
        const agendamentoId = popAgendamentoStack();
        const statusId = 4;

        try {
            await novoStatus(agendamentoId, statusId);
            mostrarMensagemConfirmacao();
        } catch (e) {
            console.log(e);
        }
    }

    function mostrarMensagemConfirmacao(mensagem) {
        if (autoDismissTimeout) {
            clearTimeout(autoDismissTimeout);
            $('#auto-dismiss-alert').alert('close');
        }

        var confirmHtml = `
        <div class="alert alert-warning alert-dismissible fade show" role="alert"
            style="background-color: white; border-color: #072B59; color: #072B59; width: 20.6vw; position: fixed; top: 20px; right: 20px; z-index: 9999;"
            id="confirm-dismiss-alert">
            Agendamento desfeito com sucesso!
            <button type="button" class="close" data-dismiss="alert" aria-label="Close" style="color: #072B59;" onclick="fecharTodosAlertas()">
                <span aria-hidden="true">&times;</span>
            </button>
            <div class="progress">
                <div class="progress-bar" id="confirm-progress-bar"></div>
            </div>
        </div>
    `;

        $('body').append(confirmHtml);

        var confirmProgressBar = $('#confirm-progress-bar');
        confirmProgressBar.css('width', '100%');

        carregarAgendamentos(paginaAtual);

        setTimeout(function () {
            $('#confirm-dismiss-alert').alert('close');
        }, 5000);

        setTimeout(function () {
            confirmProgressBar.css('width', '0%');
        }, 50);

    }

</script>